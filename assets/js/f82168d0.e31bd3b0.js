"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[1594],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),u=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=u(n),d=r,m=h["".concat(i,".").concat(d)]||h[d]||p[d]||o;return n?a.createElement(m,l(l({ref:t},c),{},{components:n})):a.createElement(m,l({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=h;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var u=2;u<o;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},7614:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const o={},l="Using AWS Batch",s={unversionedId:"scaling/remote-tasks/aws-batch",id:"scaling/remote-tasks/aws-batch",title:"Using AWS Batch",description:"Here are some useful tips and tricks related to running Metaflow on AWS Batch. See our",source:"@site/docs/scaling/remote-tasks/aws-batch.md",sourceDirName:"scaling/remote-tasks",slug:"/scaling/remote-tasks/aws-batch",permalink:"/scaling/remote-tasks/aws-batch",draft:!1,editUrl:"https://github.dev/Netflix/metaflow-docs/blob/master/docs/scaling/remote-tasks/aws-batch.md",tags:[],version:"current",frontMatter:{},sidebar:"python",previous:{title:"Using Kubernetes",permalink:"/scaling/remote-tasks/kubernetes"},next:{title:"Managing Dependencies",permalink:"/scaling/dependencies/"}},i={},u=[{value:"What value of <code>@timeout</code> should I set?",id:"what-value-of-timeout-should-i-set",level:2},{value:"How much <code>@resources</code> can I request?",id:"how-much-resources-can-i-request",level:2},{value:"My job is stuck in <code>RUNNABLE</code> state. What do I do?",id:"my-job-is-stuck-in-runnable-state-what-do-i-do",level:2},{value:"Listing and killing AWS Batch tasks",id:"listing-and-killing-aws-batch-tasks",level:2},{value:"Accessing AWS Batch logs",id:"accessing-aws-batch-logs",level:2},{value:"Disk space",id:"disk-space",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"using-aws-batch"},"Using AWS Batch"),(0,r.kt)("p",null,"Here are some useful tips and tricks related to running Metaflow on AWS Batch. See our\nengineering resources for additional information about ",(0,r.kt)("a",{parentName:"p",href:"https://outerbounds.com/docs/engineering-welcome/"},"setting up and operating AWS\nBatch for Metaflow"),"."),(0,r.kt)("h2",{id:"what-value-of-timeout-should-i-set"},"What value of ",(0,r.kt)("inlineCode",{parentName:"h2"},"@timeout")," should I set?"),(0,r.kt)("p",null,"Metaflow sets a default timeout of 5 days so that you tasks don't get stuck infinitely\nwhile running on AWS Batch. For more details on how to use ",(0,r.kt)("inlineCode",{parentName:"p"},"@timeout")," please read\n",(0,r.kt)("a",{parentName:"p",href:"/scaling/failures#timing-out-with-the-timeout-decorator"},"this.")),(0,r.kt)("h2",{id:"how-much-resources-can-i-request"},"How much ",(0,r.kt)("inlineCode",{parentName:"h2"},"@resources")," can I request?"),(0,r.kt)("p",null,"Here are the current defaults for different resource types:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cpu"),": 1"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"memory"),": 4000 ","(","4GB",")")),(0,r.kt)("p",null,"When setting ",(0,r.kt)("inlineCode",{parentName:"p"},"@resources"),", keep in mind the configuration of your AWS Batch Compute\nEnvironment. Your job will be stuck in a ",(0,r.kt)("inlineCode",{parentName:"p"},"RUNNABLE")," state if AWS is unable to provision\nthe requested resources. Additionally, as a good measure, don't request more resources\nthan what your workflow actually needs. On the other hand, never optimize resources\nprematurely."),(0,r.kt)("p",null,"You can place your AWS Batch task in a specific queue by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"queue")," argument. By\ndefault, all tasks execute on a vanilla ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/python/"},"python docker\nimage")," corresponding to the version of Python\ninterpreter used to launch the flow and can be overridden using the ",(0,r.kt)("inlineCode",{parentName:"p"},"image")," argument."),(0,r.kt)("p",null,"You can also specify the resource requirements on command line as well:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python BigSum.py run --with batch:cpu=4,memory=10000,queue=default,image=ubuntu:latest\n")),(0,r.kt)("h2",{id:"my-job-is-stuck-in-runnable-state-what-do-i-do"},"My job is stuck in ",(0,r.kt)("inlineCode",{parentName:"h2"},"RUNNABLE")," state. What do I do?"),(0,r.kt)("p",null,"Consult ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/batch/latest/userguide/troubleshooting.html#job_stuck_in_runnable"},"this\narticle"),"."),(0,r.kt)("h2",{id:"listing-and-killing-aws-batch-tasks"},"Listing and killing AWS Batch tasks"),(0,r.kt)("p",null,"If you interrupt a Metaflow run, any AWS Batch tasks launched by the run get killed by\nMetaflow automatically. Even if something went wrong during the final cleanup, the tasks\nwill finish and die eventually, at the latest when they hit the maximum time allowed for\nan AWS Batch task."),(0,r.kt)("p",null,"If you want to make sure you have no AWS Batch tasks running, or you want to manage them\nmanually, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"batch list")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"batch kill")," commands."),(0,r.kt)("p",null,"You can easily see what AWS Batch tasks were launched by your latest run with"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python myflow.py batch list\n")),(0,r.kt)("p",null,"You can kill the tasks started by the latest run with"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python myflow.py batch kill\n")),(0,r.kt)("p",null,"If you have started multiple runs, you can make sure there are no orphaned tasks still\nrunning with"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python myflow.py batch list --my-runs\n")),(0,r.kt)("p",null,"You can kill the tasks started by the latest run with"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python myflow.py batch kill --my-runs\n")),(0,r.kt)("p",null,"If you see multiple runs running, you can cherry-pick a specific job, e.g. 456, to be\nkilled as follows"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python myflow.py batch kill --run-id 456\n")),(0,r.kt)("p",null,"If you are working with another person, you can see and kill their tasks related to this\nflow with"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python myflow.py batch kill --user willsmith\n")),(0,r.kt)("p",null,"Note that all the above commands only affect the flow defined in your script. You can\nwork on many flows in parallel and be confident that ",(0,r.kt)("inlineCode",{parentName:"p"},"kill")," kills tasks only related to\nthe flow you called ",(0,r.kt)("inlineCode",{parentName:"p"},"kill")," with. "),(0,r.kt)("h2",{id:"accessing-aws-batch-logs"},"Accessing AWS Batch logs"),(0,r.kt)("p",null,"As a convenience feature, you can also see the logs of any past step as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ python bigsum.py logs 15/end\n")),(0,r.kt)("h2",{id:"disk-space"},"Disk space"),(0,r.kt)("p",null,"You can request higher disk space on AWS Batch instances by using an unmanaged Compute\nEnvironment with a custom AMI."))}p.isMDXComponent=!0}}]);