"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[3793],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(n),h=o,m=d["".concat(s,".").concat(h)]||d[h]||p[h]||r;return n?a.createElement(m,l(l({ref:t},c),{},{components:n})):a.createElement(m,l({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var u=2;u<r;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(7294),o=n(6010);const r="tabItem_Ymn6";function l(e){let{children:t,hidden:n,className:l}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(r,l),hidden:n},t)}},5488:(e,t,n)=>{n.d(t,{Z:()=>h});var a=n(7462),o=n(7294),r=n(6010),l=n(2389),i=n(7392),s=n(7094),u=n(2466);const c="tabList__CuJ",p="tabItem_LNqP";function d(e){var t;const{lazy:n,block:l,defaultValue:d,values:h,groupId:m,className:f}=e,w=o.Children.map(e.children,(e=>{if((0,o.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),g=h??w.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),y=(0,i.l)(g,((e,t)=>e.value===t.value));if(y.length>0)throw new Error(`Docusaurus error: Duplicate values "${y.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const k=null===d?d:d??(null==(t=w.find((e=>e.props.default)))?void 0:t.props.value)??w[0].props.value;if(null!==k&&!g.some((e=>e.value===k)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${k}" but none of its children has the corresponding value. Available values are: ${g.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:b,setTabGroupChoices:v}=(0,s.U)(),[S,N]=(0,o.useState)(k),T=[],{blockElementScrollPositionUntilNextRender:x}=(0,u.o5)();if(null!=m){const e=b[m];null!=e&&e!==S&&g.some((t=>t.value===e))&&N(e)}const A=e=>{const t=e.currentTarget,n=T.indexOf(t),a=g[n].value;a!==S&&(x(t),N(a),null!=m&&v(m,String(a)))},F=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{const t=T.indexOf(e.currentTarget)+1;n=T[t]??T[0];break}case"ArrowLeft":{const t=T.indexOf(e.currentTarget)-1;n=T[t]??T[T.length-1];break}}null==(t=n)||t.focus()};return o.createElement("div",{className:(0,r.Z)("tabs-container",c)},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":l},f)},g.map((e=>{let{value:t,label:n,attributes:l}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:S===t?0:-1,"aria-selected":S===t,key:t,ref:e=>T.push(e),onKeyDown:F,onFocus:A,onClick:A},l,{className:(0,r.Z)("tabs__item",p,null==l?void 0:l.className,{"tabs__item--active":S===t})}),n??t)}))),n?(0,o.cloneElement)(w.filter((e=>e.props.value===S))[0],{className:"margin-top--md"}):o.createElement("div",{className:"margin-top--md"},w.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==S})))))}function h(e){const t=(0,l.Z)();return o.createElement(d,(0,a.Z)({key:String(t)},e))}},1083:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>u,toc:()=>p});var a=n(7462),o=(n(7294),n(3905)),r=n(5488),l=n(5162);const i={},s="Scheduling Metaflow Flows",u={unversionedId:"v/r/going-to-production-with-metaflow/scheduling-metaflow-flows",id:"v/r/going-to-production-with-metaflow/scheduling-metaflow-flows",title:"Scheduling Metaflow Flows",description:"A key feature of Metaflow is to make it easy to take machine learning pipelines from",source:"@site/docs/v/r/going-to-production-with-metaflow/scheduling-metaflow-flows.md",sourceDirName:"v/r/going-to-production-with-metaflow",slug:"/v/r/going-to-production-with-metaflow/scheduling-metaflow-flows",permalink:"/v/r/going-to-production-with-metaflow/scheduling-metaflow-flows",draft:!1,editUrl:"https://github.dev/Netflix/metaflow-docs/blob/master/docs/v/r/going-to-production-with-metaflow/scheduling-metaflow-flows.md",tags:[],version:"current",frontMatter:{}},c={},p=[{value:"Why AWS Step Functions?",id:"why-aws-step-functions",level:2},{value:"Pushing a flow to production",id:"pushing-a-flow-to-production",level:2},{value:"Limiting the number of concurrent tasks",id:"limiting-the-number-of-concurrent-tasks",level:3},{value:"Scheduling a flow",id:"scheduling-a-flow",level:2}],d={toc:p};function h(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,a.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"scheduling-metaflow-flows"},"Scheduling Metaflow Flows"),(0,o.kt)("p",null,"A key feature of Metaflow is to make it easy to take machine learning pipelines from\nprototyping to production. This sentence and a number of other Metaflow documents use\nthe word production casually. What do we actually mean by it?"),(0,o.kt)("p",null,"For Machine Learning Infrastructure, production has a simple and unexciting meaning: In\nproduction, the flow should run without any human intervention. If your flow produced\nvalid results during development, we want it to produce equally valid results in\nproduction - just without anyone managing it manually."),(0,o.kt)("p",null,"Eventually, something will fail in production, and human intervention is needed. In\nthese cases, we want to minimize the amount of human intervention and the time spent on\ndebugging."),(0,o.kt)("p",null,"If your flow is built with Metaflow best practices, making it run automatically in\nproduction should not be a big deal."),(0,o.kt)("p",null,"By this definition, you can not run your flow with"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Rscript helloworld.R run\n")),(0,o.kt)("p",null,"in production as it requires someone to type the command manually. A classic solution is\nto have cron or another similar time-based scheduler to run the command automatically at\na set schedule."),(0,o.kt)("p",null,"It is not easy to use cron as a production scheduler. What if the instance running cron\nfails? If the scheduled command fails, how do I know it has failed? How do you see its\nerror logs? Does my cron instance have enough capacity to handle another command? And\nmost importantly, how do I orchestrate schedules of multiple commands so that their\nmutual dependencies are handled correctly?"),(0,o.kt)("h2",{id:"why-aws-step-functions"},"Why AWS Step Functions?"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://aws.amazon.com/step-functions/"},"AWS Step Functions")," is a general-purpose\nworkflow orchestrator that can answer these questions. If you are curious, you can ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html"},"read\nAWS Step Functions documentation to learn all about\nit"),". If you just want\nto get your flow in production, this document contains everything you need to know."),(0,o.kt)("p",null,"In the Metaflow's point of view, the main benefits of AWS Step Functions are the\nfollowing:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"AWS Step Functions orchestrates workflows expressed as state machines, which are a\nsuperset of directed graphs. This means that we can map Metaflow flows to\ncorresponding AWS Step Functions state machines fully automatically. This gives you\nmuch more detail about what gets executed and how, in contrast to treating Metaflow\nscripts as black boxes."),(0,o.kt)("li",{parentName:"ul"},"AWS Step Functions comes with tooling that is required for running workflows in\nproduction. You can benefit from battle-hardened solutions provided by AWS for\nalerting, monitoring, and scheduling. By using AWS Step Functions your Metaflow flows\ncan integrate seamlessly with the wider AWS offerings.")),(0,o.kt)("p",null,"When running on AWS Step Functions, Metaflow code works exactly as it does locally: No\nchanges are required in the code. All data artifacts produced by steps run on AWS Step\nFunctions are available using the ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/client"},"Client API"),". All tasks are run\non AWS Batch respecting the ",(0,o.kt)("inlineCode",{parentName:"p"},"@resources")," decorator, as explained in ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/scaling"},"Scaling Out and\nUp"),"."),(0,o.kt)("p",null,"This document describes the basics of AWS Step Functions scheduling. If your project\ninvolves multiple people, multiple workflows, or it is becoming business-critical, we\nwill soon introduce a new feature around coordinating larger Metaflow projects."),(0,o.kt)("h2",{id:"pushing-a-flow-to-production"},"Pushing a flow to production"),(0,o.kt)("p",null,"Let's use ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/basics#how-to-define-parameters-for-flows"},"the flow from the section about\nparameters")," as an example:"),(0,o.kt)(r.Z,{mdxType:"Tabs"},(0,o.kt)(l.Z,{label:"R",value:"R",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'library(metaflow)\n\nstart <- function(self){\n    print(paste("alpha is", self$alpha))\n}\n\nend <- function(self){\n    print(paste("alpha still is", self$alpha))\n}\n\nmetaflow("ParameterFlow") %>%\n    parameter("alpha",\n              help="learning rate",\n              default = 0.1) %>%\n    step(step="start",\n         r_function=start,\n         next_step="end") %>%\n    step(step="end",\n         r_function=end) %>%\n    run()\n'))),(0,o.kt)(l.Z,{label:"RStudio",value:"RStudio",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'...\n   step(step="end",\n         r_function=end) %>%\n   run(step_functions = "create")\n')))),(0,o.kt)("p",null,"Save this script to a file ",(0,o.kt)("inlineCode",{parentName:"p"},"parameter_flow.R"),". To deploy a version to AWS Step\nFunctions, simply source the ",(0,o.kt)("inlineCode",{parentName:"p"},"RStudio")," version of the code or in a terminal run"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Rscript parameter_flow.R --with retry step-functions create\n")),(0,o.kt)("p",null,"This command takes a snapshot of your code in the working directory, as well as the\nversion of Metaflow used, and exports the whole package to AWS Step Functions for\nscheduling."),(0,o.kt)("p",null,"It is highly recommended that you ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/failures#retrying-tasks-with-the-retry-decorator"},"enable\nretries")," when deploying\nto AWS Step Functions, which you can do easily with --with retry as shown above.\nHowever, make sure that all your steps are safe to retry before you do this. If some of\nyour steps interact with external services in ways that can't tolerate automatic\nretries, decorate them with retry with times set to zero ","(","times=0",")"," as described in\n",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/failures#how-to-prevent-retries"},"How to Prevent Retries"),"."),(0,o.kt)("p",null,"The command will export your workflow to AWS Step Functions. You can also search for the\nflow by name within the AWS Step Functions UI. You should see a visualization of the\nexported flow, like here:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(2148).Z,width:"1999",height:"1090"})),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(3781).Z,width:"1999",height:"172"})),(0,o.kt)("p",null,"You can click the orange Start Execution button to execute the flow on AWS Step\nFunctions. It pops up a dialog asking for an input. You can specify your parameters as\nan escaped JSON string with Parameters as the key - ",(0,o.kt)("em",{parentName:"p"},"*","*")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'{\n    "Parameters" : "{\\"alpha\\": 0.5}"\n}\n')),(0,o.kt)("p",null,"Metaflow automatically maps Parameters of your flow to corresponding parameters on AWS\nStep Functions."),(0,o.kt)("p",null,"After you click Start Execution on the Input dialog, AWS Step Functions starts running\nthe flow:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(8343).Z,width:"1999",height:"931"})),(0,o.kt)("p",null,"In this case, the run should succeed without problems. If there were errors, you could\nreproduce them locally as explained in ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/debugging"},"Debugging with\nMetaflow"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"You can trigger the workflow through command line as well:")),(0,o.kt)(r.Z,{mdxType:"Tabs"},(0,o.kt)(l.Z,{label:"Bash",value:"Bash",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Rscript parameter_flow.R step-functions trigger --alpha 0.5\n"))),(0,o.kt)(l.Z,{label:"RStudio",value:"RStudio",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'...\n   step(step="end",\n         r_function=end) %>%\n   run(step-functions="trigger",\n       alpha=0.5)\n')))),(0,o.kt)("p",null,"If you run ",(0,o.kt)("inlineCode",{parentName:"p"},"step-functions create")," again, it will create a new version of your flow on\nAWS Step Functions. The newest version becomes the production version automatically\n","(","due to the consistency guarantees provided by AWS Step Functions, it might be a couple\nof seconds before this happens",")",". If you want to test on AWS Step Functions without\ninterfering with a production flow, you can change the name of your class, e.g. from\nParameterFlow to ParameterFlowStaging, and ",(0,o.kt)("inlineCode",{parentName:"p"},"step-functions create")," the flow under a new\nname."),(0,o.kt)("p",null,"Note that step-functions creates a new isolated ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/tagging#tags-as-namespaces"},"production\nnamespace")," for your production flow. Please\nread ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/tagging"},"Organizing Results")," to learn all about namespace behavior."),(0,o.kt)("h3",{id:"limiting-the-number-of-concurrent-tasks"},"Limiting the number of concurrent tasks"),(0,o.kt)("p",null,"By default, Metaflow configures AWS Step Functions to execute at most 100 tasks\nconcurrently within a foreach step. This should ensure that most workflows finish\nquickly without overwhelming your AWS Batch queue, the execution backend."),(0,o.kt)("p",null,"If your workflow includes a large ",(0,o.kt)("inlineCode",{parentName:"p"},"foreach")," and you need results faster, you can\nincrease the default with the ",(0,o.kt)("inlineCode",{parentName:"p"},"--max-workers")," option. For instance, ",(0,o.kt)("inlineCode",{parentName:"p"},"step-functions\ncreate --max-workers 500")," allows 500 tasks to be executed concurrently for every foreach\nstep."),(0,o.kt)("p",null,"This option is similar to ",(0,o.kt)("a",{parentName:"p",href:"/v/r/metaflow/scaling#safeguard-flags"},(0,o.kt)("inlineCode",{parentName:"a"},"run --max-workers")),"\nthat is used to limit concurrency outside AWS Step Functions."),(0,o.kt)("h2",{id:"scheduling-a-flow"},"Scheduling a flow"),(0,o.kt)("p",null,"By default, a flow on AWS Step Functions does not run automatically. You need to set up\na trigger to launch the flow when an event occurs."),(0,o.kt)("p",null,"Metaflow provides built-in support for triggering Metaflow flows through time-based\n","(","cron",")"," triggers. Use a time-based trigger if you want to trigger the workflow at a\ncertain time."),(0,o.kt)("p",null,"Time-based triggers are implemented at the FlowSpec-level using the ",(0,o.kt)("inlineCode",{parentName:"p"},"schedule"),"\ndecorator. This flow is triggered hourly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'library(metaflow)\n\nstart <- function(self){\n    print(Sys.time())\n}\n\nend <- function(self){\n    print("Scheduled successfully")\n}\n\nmetaflow("ScheduledFlow",\n    decorator("schedule", hourly=TRUE)) %>%\n    step(step="start",\n         r_function=start,\n         next_step="end") %>%\n    step(step="end",\n         r_function=end) %>%\n    run()\n')),(0,o.kt)("p",null,"You can define the schedule with ",(0,o.kt)("inlineCode",{parentName:"p"},"decorator")," in one of the following ways:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'decorator("schedule", weekly=True)')," runs the workflow on Sundays at midnight."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'decorator("schedule", daily=True)')," runs the workflow every day at midnight."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'decorator("schedule", hourly=True)')," runs the workflow every hour."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"decorator(\"schedule\", cron='0 10 * * ? *')")," runs the workflow at the given\n",(0,o.kt)("a",{parentName:"li",href:"http://en.wikipedia.org/wiki/cron"},"Cron")," schedule, in this case at 10am UTC every\nday. You can use the rules defined\n",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eventbridge/latest/userguide/scheduled-events.html"},"here"),"\nto define the schedule for the cron option.")))}h.isMDXComponent=!0},2148:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/image2-bfe069afec6d8baa6f2df66eca8b1e33.png"},3781:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/image5-c0529acd1bc60a0e294d98d68e0dd33b.png"},8343:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/image6-6752bb3387ee674b969de12be8053326.png"}}]);