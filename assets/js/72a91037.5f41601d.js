"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[4978],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>u});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var p=a.createContext({}),s=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=s(e.components);return a.createElement(p.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=s(t),u=i,h=m["".concat(p,".").concat(u)]||m[u]||d[u]||r;return t?a.createElement(h,o(o({ref:n},c),{},{components:t})):a.createElement(h,o({ref:n},c))}));function u(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=m;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},9472:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=t(7462),i=(t(7294),t(3905));const r={},o="Internals of Dependency Management",l={unversionedId:"scaling/dependencies/internals",id:"scaling/dependencies/internals",title:"Internals of Dependency Management",description:"Behind the scenes, Metaflow does much more than just wrapping CLI commands such as",source:"@site/docs/scaling/dependencies/internals.md",sourceDirName:"scaling/dependencies",slug:"/scaling/dependencies/internals",permalink:"/scaling/dependencies/internals",draft:!1,editUrl:"https://github.dev/Netflix/metaflow-docs/blob/master/docs/scaling/dependencies/internals.md",tags:[],version:"current",frontMatter:{},sidebar:"python",previous:{title:"Defining Custom Images",permalink:"/scaling/dependencies/containers"},next:{title:"Dependencies FAQ",permalink:"/scaling/dependencies/faq"}},p={},s=[{value:"How <code>@pypi</code> and <code>@conda</code> work",id:"how-pypi-and-conda-work",level:2},{value:"Runtime operation",id:"runtime-operation",level:3}],c={toc:s};function d(e){let{components:n,...r}=e;return(0,i.kt)("wrapper",(0,a.Z)({},c,r,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"internals-of-dependency-management"},"Internals of Dependency Management"),(0,i.kt)("p",null,"Behind the scenes, Metaflow does much more than just wrapping CLI commands such as\n",(0,i.kt)("inlineCode",{parentName:"p"},"pip install")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"conda install"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"It creates isolated virtual environments for every step on the fly, automatically,\ncaching them for future use."),(0,i.kt)("li",{parentName:"ul"},"It supports pinning of the ",(0,i.kt)("inlineCode",{parentName:"li"},"python")," interpreter version which ",(0,i.kt)("inlineCode",{parentName:"li"},"pip")," doesn't\nsupport natively."),(0,i.kt)("li",{parentName:"ul"},"It resolves the full dependency graph of every step, locking the graph for\nstability and reproducibility, storing the metadata for auditing."),(0,i.kt)("li",{parentName:"ul"},"It ships the locally resolved environment for remote execution, even when\nthe remote environment uses a different operating system and CPU architecture\nthan the client (OS X vs. Linux)."),(0,i.kt)("li",{parentName:"ul"},"It snapshots all packages in the datastore, making it possible to rehydrate\nenvironments in even thousands of parallel containers, which would cause\nhiccups with parallel ",(0,i.kt)("inlineCode",{parentName:"li"},"pip install"),"s.")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"For even more features, see ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Netflix/metaflow-nflx-extensions"},"Netflix's Metaflow\nExtensions")," which contain even\nmore featureful ",(0,i.kt)("inlineCode",{parentName:"p"},"@pypi")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"@conda"),".")),(0,i.kt)("h2",{id:"how-pypi-and-conda-work"},"How ",(0,i.kt)("inlineCode",{parentName:"h2"},"@pypi")," and ",(0,i.kt)("inlineCode",{parentName:"h2"},"@conda")," work"),(0,i.kt)("p",null,"Here's what happens under the hood when you specify ",(0,i.kt)("inlineCode",{parentName:"p"},"--environment=pypi")," or\n",(0,i.kt)("inlineCode",{parentName:"p"},"--environment=conda"),". Both the options work the same way, as illustrated by\nthis diagram:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"package ecosystem",src:t(5683).Z,width:"3000",height:"1687"})),(0,i.kt)("p",null,"Let's go over the operation following the blue steps, starting at the top:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Local ",(0,i.kt)("inlineCode",{parentName:"p"},".py")," files and others specified by ",(0,i.kt)("inlineCode",{parentName:"p"},"--package-suffixes")," are ",(0,i.kt)("a",{parentName:"p",href:"/scaling/dependencies/project-structure"},"packaged\nin a code package as usual"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"When using ",(0,i.kt)("inlineCode",{parentName:"p"},"@pypi")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"@conda"),", every step gets its own virtual environment."),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If two steps have the same exact set of packages, the environment is\nreused across the steps."),(0,i.kt)("li",{parentName:"ul"},"The environment is created using ",(0,i.kt)("inlineCode",{parentName:"li"},"mamba")," and the\ndesired version of ",(0,i.kt)("inlineCode",{parentName:"li"},"python")," is installed."),(0,i.kt)("li",{parentName:"ul"},"For step-specific dependency resolution, ",(0,i.kt)("inlineCode",{parentName:"li"},"@pypi")," invokes\n",(0,i.kt)("inlineCode",{parentName:"li"},"pip"),", whereas ",(0,i.kt)("inlineCode",{parentName:"li"},"@conda")," uses ",(0,i.kt)("inlineCode",{parentName:"li"},"mamba"),"."),(0,i.kt)("li",{parentName:"ul"},'The full list of exact packages aka "a lockfile" is stored in the\ncode package corresponding to a run or a deployment.'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once a full list of packages has been created for each step,\npackages are downloaded in parallel and stored locally.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"The packages are uploaded in the Metaflow datastore, e.g. S3 in the case\nof AWS-based configuration. This ensures that remote tasks won't need to\ndownload packages repeatedly and redundantly from an upstream package\nrepository."))),(0,i.kt)("p",null,"This completes operations on the client side. The\ncode package together with the cached packages in the datastore contain\na complete, isolated environment for each step which is needed to\nexecute its tasks."),(0,i.kt)("h3",{id:"runtime-operation"},"Runtime operation"),(0,i.kt)("p",null,"When ",(0,i.kt)("inlineCode",{parentName:"p"},"@pypi")," / ",(0,i.kt)("inlineCode",{parentName:"p"},"@conda")," -enabled tasks execute remotely, we start by\nsetting up an empty virtual environment with ",(0,i.kt)("inlineCode",{parentName:"p"},"mamba"),", download the\ncached packages from the datastore, and unpack them in the environment.\nThe code package is unpacked to make local dependencies available."),(0,i.kt)("p",null,"After this, the task is executed in an environment that contains\nexactly the specified packages. Nothing more, nothing less."))}d.isMDXComponent=!0},5683:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/dependency-internals-2b8b37b7b1382840037bb6c160510b6e.png"}}]);